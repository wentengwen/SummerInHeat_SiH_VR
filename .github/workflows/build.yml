name: Build and Release UnityVRMod

on:
  # Run on pushes to the main branch for continuous integration
  push:
    branches: [ main, dev ]
  # Run when a new release is published in GitHub
  release:
    types: [ published ]

jobs:
  build-and-package:
    runs-on: windows-latest

    steps:
      # Step 1: Check out the repository's code
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Run the PowerShell build script
      # This script is responsible for building the C++ helper and all C# configurations.
      - name: Run Build Script
        shell: pwsh
        run: ./build.ps1
        
      # Step 3: Get the version for naming the artifacts
      # This extracts the version from the release tag (e.g., "v0.1.0-beta")
      # For main branch pushes, it will use the short commit hash as a unique identifier.
      - name: Get Version Name
        id: get_version
        shell: pwsh
        run: |
          if ($env:GITHUB_EVENT_NAME -eq 'release') {
            $version = "${{ github.event.release.tag_name }}"
          } else {
            $version = "ci-${{ github.sha }}"
          }
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV

      # Step 4: Archive each build configuration into a separate .zip file
      - name: Archive Builds
        shell: pwsh
        run: |
          Compress-Archive -Path Release/OpenXR/UnityVRMod.BepInEx.IL2CPP/* -DestinationPath UnityVRMod-${{ env.VERSION }}-OpenXR-IL2CPP.zip
          Compress-Archive -Path Release/OpenXR/UnityVRMod.BepInEx.Mono/* -DestinationPath UnityVRMod-${{ env.VERSION }}-OpenXR-Mono.zip
          Compress-Archive -Path Release/OpenVR/UnityVRMod.BepInEx.IL2CPP/* -DestinationPath UnityVRMod-${{ env.VERSION }}-OpenVR-IL2CPP.zip
          Compress-Archive -Path Release/OpenVR/UnityVRMod.BepInEx.Mono/* -DestinationPath UnityVRMod-${{ env.VERSION }}-OpenVR-Mono.zip
          
      # Step 5: If this is a 'release' event, upload the zipped artifacts to the GitHub Release page
      - name: Upload Assets to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            UnityVRMod-*.zip

      # Step 6: If this is just a 'push' to main, upload the zips as temporary build artifacts
      # This allows for testing and verification without creating a full release.
      - name: Upload Artifacts for CI
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: UnityVRMod-Builds-${{ env.VERSION }}
          path: UnityVRMod-*.zip
